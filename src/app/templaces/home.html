<script>
    const fileInput = document.getElementById('file');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const form = document.getElementById('uploadForm');
    const popup = document.getElementById('popup');
    const tableBody = document.querySelector('.file-list-container tbody');

    // Mostrar nombre del archivo seleccionado
    if(fileInput) {
        fileInput.addEventListener('change', () => {
            const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
            fileNameDisplay.textContent = fileName ? `Selected file: ${fileName}` : '';
        });
    }

    // Manejo del envío del formulario
    if(form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            try {
                // Paso 1: subir archivo
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    alert("Upload failed.");
                    return;
                }

                const file = await uploadResponse.json();

                // Paso 2: firmar (el backend decide si aplica)
                const signResponse = await fetch('/sign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_id: file.id })
                });

                if (!signResponse.ok) {
                    alert("Signing failed.");
                    return;
                }

                const signed = await signResponse.json();

                // Mostrar popup
                popup.textContent = signed.status === "signed"
                    ? "File successfully uploaded and signed"
                    : "File uploaded. Awaiting approval for production";

                popup.style.display = 'block';
                setTimeout(() => popup.style.display = 'none', 3000);

                // Agregar fila a la tabla
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${signed.id}</td>
                    <td>${signed.filename}</td>
                    <td class="environment env-${signed.environment}">${signed.environment}</td>
                    <td><span class="status ${signed.status}">${signed.status}</span></td>
                    <td>${signed.uploaded_at || '—'}</td>
                    <td>${signed.signed_path ? `<a href="${signed.signed_path}" class="download-link">Download</a>` : '—'}</td>
                    <td>${signed.signature || '—'}</td>
                `;

                if (tableBody) {
                    tableBody.appendChild(newRow);
                }

                form.reset();
                fileNameDisplay.textContent = '';

            } catch (error) {
                console.error("Error in upload/sign flow:", error);
                alert("Error during upload/sign process.");
            }
        });
    }
</script>